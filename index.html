<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cyberpunk Financial Dashboard</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@500&display=swap');

    :root {
      --bg-color: #0d0d0d;
      --text-color: #ffffff;
      --accent1: #ff00ff;
      --accent2: #00fff7;
      --card-bg: rgba(26, 26, 26, 0.7);
      --hover-bg: rgba(38, 38, 38, 0.7);
      --glass-blur: blur(8px);
    }

    body.day-mode {
      --bg-color: #f5f5f5;
      --text-color: #111;
      --accent1: #0077ff;
      --accent2: #00bcd4;
      --card-bg: rgba(255, 255, 255, 0.85);
      --hover-bg: rgba(238, 238, 238, 0.85);
      --glass-blur: none;
    }

    body {
      font-family: 'Orbitron', sans-serif;
      background-color: var(--bg-color);
      color: var(--text-color);
      padding: 30px;
      margin: 0;
      transition: background 0.3s, color 0.3s;
    }

    h1 {
      text-align: center;
      color: var(--accent1);
      text-shadow: 0 0 5px var(--accent1);
      margin-bottom: 40px;
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .logo {
      font-size: 14px;
      font-weight: bold;
      color: var(--accent2);
    }

    .toggle-mode {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background-color: var(--card-bg);
      border: 1px solid var(--accent1);
      color: var(--accent1);
      padding: 10px 15px;
      border-radius: 8px;
      cursor: pointer;
      box-shadow: 0 0 10px var(--accent1);
      transition: background 0.3s, color 0.3s;
    }

    .dashboard {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 30px;
    }

    .card {
      background: var(--card-bg);
      backdrop-filter: var(--glass-blur);
      border: 2px solid var(--accent2);
      box-shadow: 0 0 15px var(--accent2);
      border-radius: 12px;
      width: 280px;
      padding: 20px;
      text-align: center;
      transition: transform 0.3s ease, box-shadow 0.3s;
      position: relative;
    }

    .card:hover {
      transform: scale(1.05);
      box-shadow: 0 0 25px var(--accent1);
    }

    .card h2 {
      color: var(--accent2);
      font-size: 20px;
      margin-bottom: 10px;
    }

    .card p {
      font-size: 24px;
      font-weight: bold;
      color: var(--text-color);
      text-shadow: 0 0 5px var(--accent2);
    }

    .card .tooltip {
      position: absolute;
      top: 10px;
      right: 10px;
      background-color: var(--hover-bg);
      color: var(--text-color);
      padding: 4px 8px;
      font-size: 12px;
      border-radius: 4px;
      box-shadow: 0 0 5px var(--accent1);
      display: none;
    }

    .card:hover .tooltip {
      display: block;
    }

    .category-table {
      margin: 50px auto 0 auto;
      background: var(--card-bg);
      backdrop-filter: var(--glass-blur);
      padding: 25px;
      border-radius: 12px;
      max-width: 600px;
      box-shadow: 0 0 15px var(--accent1);
    }

    .category-table h3 {
      text-align: center;
      color: var(--accent1);
      margin-bottom: 20px;
      text-shadow: 0 0 5px var(--accent1);
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th, td {
      padding: 12px;
      border-bottom: 1px solid #333;
      color: var(--accent2);
      text-align: left;
    }

    tr:hover {
      background-color: var(--hover-bg);
    }

    .currency-selector {
      text-align: center;
      margin-top: 30px;
    }

    .currency-selector select {
      padding: 8px 12px;
      border-radius: 6px;
      font-family: 'Orbitron', sans-serif;
      background-color: var(--card-bg);
      color: var(--accent1);
      border: 1px solid var(--accent1);
    }

    form {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      margin-top: 10px;
    }

    form input, form select, form button {
      padding: 10px;
      border-radius: 8px;
      border: 1px solid var(--accent1);
      background-color: var(--card-bg);
      color: var(--text-color);
      font-family: 'Orbitron', sans-serif;
      min-width: 120px;
    }

    @media (max-width: 768px) {
      .dashboard {
        flex-direction: column;
        align-items: center;
      }

      .card {
        width: 90%;
      }
    }
  </style>
</head>
<body>
  <div class="top-bar">
    <div class="logo">© 2025 Joy Finance</div>
  </div>

  <h1>Cyberpunk Financial Dashboard</h1>

  <div class="currency-selector">
    <label for="currency">Currency: </label>
    <select id="currency">
      <option value="KRW">₩ KRW</option>
      <option value="USD">$ USD</option>
      <option value="EUR">€ EUR</option>
    </select>
  </div>

  <div class="dashboard">
    <div class="card">
      <div class="tooltip">Total earned income</div>
      <h2>Total Income</h2>
      <p id="income">₩0</p>
    </div>
    <div class="card">
      <div class="tooltip">All expenses combined</div>
      <h2>Total Expenses</h2>
      <p id="expense">₩0</p>
    </div>
    <div class="card">
      <div class="tooltip">Income minus expenses</div>
      <h2>Net Balance</h2>
      <p id="balance">₩0</p>
    </div>
  </div>

  <div class="category-table">
    <h3>Expenses by Category</h3>
    <table id="categoryTable">
      <tr><th>Category</th><th>Amount</th></tr>
    </table>
  </div>

  <div class="category-table">
    <h3>Spending by Category</h3>
    <canvas id="categoryChart" width="400" height="400"></canvas>
  </div>

  <div class="category-table" style="margin-top: 60px;">
    <h3>Add a Transaction</h3>
    <form id="entryForm">
      <input type="date" id="date" required />
      <input type="text" id="category" placeholder="Category" required />
      <input type="text" id="description" placeholder="Description" required />
      <select id="type" required>
        <option value="Income">Income</option>
        <option value="Expenses">Expenses</option>
      </select>
      <input type="number" id="amount" placeholder="Amount (₩)" required min="0" />
      <button type="submit">Submit</button>
    </form>
    <p id="entryMsg" style="text-align:center; margin-top:10px;"></p>
  </div>

  <button class="toggle-mode" onclick="toggleMode()">Toggle Mode</button>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const scriptUrl = "https://script.google.com/macros/s/AKfycbxL6ErwKSEA94MCsLmUHTDYvldl9esVKLB0CDmgzfXIMMDOKNmbSFsCD7n1zPyauhVzOw/exec";

    function convertDateFormat(dateString) {
      // Convert yyyy-mm-dd to dd-mm-yy
      const parts = dateString.split("-");
      const dd = parts[2];
      const mm = parts[1];
      const yy = parts[0].slice(2);
      return `${dd}-${mm}-${yy}`;
    }

    async function fetchData() {
      try {
        const response = await fetch(scriptUrl + "?action=getData");
        const data = await response.json();

        updateDashboard(data);
        updateCategoryTable(data);
        updateCategoryChart(data);
      } catch (error) {
        console.error("Fetch error:", error);
      }
    }

    function formatCurrency(value, currency) {
      return new Intl.NumberFormat('en-US', { style: 'currency', currency: currency }).format(value);
    }

    function updateDashboard(data) {
      let income = 0;
      let expenses = 0;
      data.forEach(entry => {
        if (entry.Type === "Income") income += Number(entry.Amount);
        else if (entry.Type === "Expenses") expenses += Number(entry.Amount);
      });
      const balance = income - expenses;

      const currency = document.getElementById("currency").value;

      document.getElementById("income").textContent = formatCurrency(income, currency);
      document.getElementById("expense").textContent = formatCurrency(expenses, currency);
      document.getElementById("balance").textContent = formatCurrency(balance, currency);
    }

    function updateCategoryTable(data) {
      const table = document.getElementById("categoryTable");
      // Clear all rows except header
      while (table.rows.length > 1) table.deleteRow(1);

      const categoryTotals = {};
      data.forEach(entry => {
        if (entry.Type === "Expenses") {
          categoryTotals[entry.Category] = (categoryTotals[entry.Category] || 0) + Number(entry.Amount);
        }
      });

      for (const [cat, amt] of Object.entries(categoryTotals)) {
        const row = table.insertRow();
        const cell1 = row.insertCell(0);
        const cell2 = row.insertCell(1);
        cell1.textContent = cat;
        cell2.textContent = formatCurrency(amt, document.getElementById("currency").value);
      }
    }

    let categoryChart;
    function updateCategoryChart(data) {
      const ctx = document.getElementById("categoryChart").getContext('2d');
      const categoryTotals = {};
      data.forEach(entry => {
        if (entry.Type === "Expenses") {
          categoryTotals[entry.Category] = (categoryTotals[entry.Category] || 0) + Number(entry.Amount);
        }
      });
      const labels = Object.keys(categoryTotals);
      const amounts = Object.values(categoryTotals);

      if (categoryChart) categoryChart.destroy();

      categoryChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: labels,
          datasets: [{
            data: amounts,
            backgroundColor: [
              '#FF00FF', '#00FFF7', '#FF007F', '#00FF90',
              '#FF4500', '#1E90FF', '#FFD700', '#ADFF2F'
            ],
            borderWidth: 1
          }]
        },
        options: {
          plugins: {
            legend: { position: 'right', labels: { color: 'var(--accent2)' } }
          }
        }
      });
    }

    document.getElementById("currency").addEventListener("change", fetchData);

    document.getElementById("entryForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const date = convertDateFormat(document.getElementById("date").value);
      const category = document.getElementById("category").value.trim();
      const description = document.getElementById("description").value.trim();
      const type = document.getElementById("type").value;
      const amount = Number(document.getElementById("amount").value);

      if (!date || !category || !description || !type || amount <= 0) {
        alert("Please fill in all fields correctly.");
        return;
      }

      const payload = {
        date: date,
        category: category,
        description: description,
        type: type,
        amount: amount
      };

      try {
        const response = await fetch(scriptUrl + "?action=addData", {
          method: "POST",
          body: JSON.stringify(payload),
          headers: { "Content-Type": "application/json" }
        });

        const result = await response.json();

        if (result.status === "success") {
          document.getElementById("entryMsg").textContent = "Entry added successfully!";
          document.getElementById("entryMsg").style.color = "limegreen";
          e.target.reset();
          fetchData();
        } else {
          document.getElementById("entryMsg").textContent = "Failed to add entry.";
          document.getElementById("entryMsg").style.color = "red";
        }
      } catch (error) {
        console.error(error);
        document.getElementById("entryMsg").textContent = "Error adding entry.";
        document.getElementById("entryMsg").style.color = "red";
      }
    });

    function toggleMode() {
      document.body.classList.toggle("day-mode");
      fetchData();
    }

    // Initial load
    fetchData();
  </script>
</body>
</html>
